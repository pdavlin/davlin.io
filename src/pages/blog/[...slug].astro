---
import Layout from '@components/Layout.astro';
import DocumentHead from '@components/DocumentHead.astro';
import { getCollection } from 'astro:content';
import '@styles/global.css';
import { formatDate } from '../../utils/date-utils';

export async function getStaticPaths() {
  const notes = await getCollection('notes');
  const posts = notes.filter((note) => note.data.type !== 'film');
  return posts.map((note) => ({
    params: { slug: note.slug },
    props: { note },
  }));
}

const { slug } = Astro.params;
const { note } = Astro.props;

if (slug === undefined) return;

const { Content } = await note.render();

const {
  data: { added, excerpt, title, updated, tags },
} = note;

// random imageId between 1 and 6
const imageId = Math.floor(Math.random() * 6) + 1;

const description = excerpt;
const permalink = `https://davlin.io/blog/${slug}/`;
---

<html lang="en">
  <DocumentHead
    title={title}
    description={description ?? ''}
    permalink={permalink}
    canonicalUrl={permalink}
    imageId={imageId}
  />
  <body>
    <Layout page="post">
      <article>
        <fieldset class="meta">
          <legend>metadata</legend>
          <h1 class="title">{title}</h1>
          <dl class="meta-list">
            <dt>added</dt>
            <dd>{formatDate(added)}</dd>
            {
              updated !== added && (
                <>
                  <dt>updated</dt>
                  <dd>{formatDate(updated)}</dd>
                </>
              )
            }
            {
              tags && tags.length > 0 && (
                <>
                  <dt>tags</dt>
                  <dd class="tags">{tags.join(', ')}</dd>
                </>
              )
            }
          </dl>
        </fieldset>
        <div class="prose flow styled-link-underlines">
          <Content />
        </div>
      </article>
      <section class="styled-link-underlines thanks-for-reading">
        <a href="/blog/">Back to posts</a>
      </section>
    </Layout>
    <style>
      /* Desktop: white underline, accent on hover */
      a {
        text-decoration-color: var(--color-text);
      }

      a:hover {
        text-decoration-color: var(--accent-color);
      }

      /* Mobile: always accent color underline (no hover) */
      @media (max-width: 600px) {
        a {
          text-decoration-color: var(--accent-color);
        }
      }

      .meta-list {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 0.25em 0.75em;
        margin: 0;
        font-size: 0.85em;
      }

      .meta-list dt {
        color: var(--base_03);
      }

      .meta-list dd {
        margin: 0;
      }

      .prose img {
        width: 100%;
        height: auto;
        border-radius: var(--radius-l);
      }

      .prose * + :is(h2, h3, h4) {
        --flow-space: var(--space_xl);
      }

      .prose pre[class*='language-'],
      .prose figure {
        margin-block: var(--space_l) var(--space_s);
        grid-column: popout;
      }
    </style>
  </body>
</html>
